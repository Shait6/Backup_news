parameters:
- name: subscriptionId
  type: string
  default: ''
- name: managementGroupId
  type: string
  default: ''
- name: vmTagName
  type: string
  default: 'backup'
- name: vmTagValue
  type: string
  default: 'true'
- name: location
  type: string
  values:
    - westeurope
    - northeurope
    - swedencentral
    - germanywestcentral
  default: westeurope
- name: resourceGroupName
  type: string
  displayName: 'Resource Group Name'
  default: 'rg-vmbackup-default'
- name: vaultName
  type: string
  displayName: 'Recovery Services Vault Name'
  default: 'rsv-backup-default'
- name: vaultSkuName
  type: string
  displayName: 'Recovery Services Vault SKU Name'
  default: 'RS0'
- name: vaultSkuTier
  type: string
  displayName: 'Recovery Services Vault SKU Tier'
  default: 'Standard'
  
- name: backupPolicyName
  type: string
  displayName: 'Backup Policy Name'
  default: 'DefaultPolicy'
- name: enableBackup
  type: string
  values:
    - 'true'
    - 'false'
  default: 'true'
  displayName: 'Enable VM Backup'
- name: backupFrequency
  type: string
  values:
    - 'Daily'
    - 'Weekly'
    - 'Both'
  default: 'Daily'
  displayName: 'Backup Frequency'
- name: dailyRetentionDays
  type: number
  default: '14'
  displayName: 'Daily Backup Retention Days'
- name: weeklyRetentionDays
  type: number
  default: '30'
  displayName: 'Weekly Backup Retention Days'
- name: enableAutoRemediation
  type: string
  values:
    - 'true'
    - 'false'
  default: 'false'
  displayName: 'Enable Auto-Remediation (DeployIfNotExists)'
- name: createVault
  type: string
  values:
    - 'true'
    - 'false'
  default: 'false'
  displayName: 'Create Recovery Services Vault if not exists'
- name: vaultResourceGroup
  type: string
  default: ''
  displayName: 'Vault Resource Group (if creating vault)'
pool:
  vmImage: 'windows-latest'

stages:
- stage: Deploy
  jobs:
  - job: PrepareParameters
    displayName: 'Prepare Parameters'
    steps:
    - task: AzurePowerShell@5
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        ScriptType: 'FilePath'
        ScriptPath: '$(System.DefaultWorkingDirectory)/scripts/Set-DeploymentParameters.ps1'
        ScriptArguments: >
          -Location "${{ parameters.location }}"
          -SubscriptionId "${{ parameters.subscriptionId }}"
          -VaultName "${{ parameters.vaultName }}"
          -BackupPolicyName "${{ parameters.backupPolicyName }}"
          -DailyRetentionDays ${{ parameters.dailyRetentionDays }}
          -WeeklyRetentionDays ${{ parameters.weeklyRetentionDays }}
          -VaultSkuName "${{ parameters.vaultSkuName }}" \
          -VaultSkuTier "${{ parameters.vaultSkuTier }}"
        azurePowerShellVersion: 'LatestVersion'
    # (Removed) Collect deployment operations and artifact publish steps per user request

    - task: AzureCLI@2
      displayName: 'Create role assignment for UAI (wait until principal exists)'
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euo pipefail
          rgName="${{ parameters.resourceGroupName }}"
          # read outputs from group deployment
          identityPrincipal=$(az deployment group show --name main --resource-group "$rgName" --query properties.outputs.userAssignedIdentityPrincipalId.value -o tsv || true)
          identityId=$(az deployment group show --name main --resource-group "$rgName" --query properties.outputs.userAssignedIdentityId.value -o tsv || true)
          if [ -z "$identityPrincipal" ] || [ -z "$identityId" ]; then
            echo "Failed to resolve identity outputs from group deployment"
            exit 1
          fi

          echo "Waiting for AAD replication for principal $identityPrincipal (helper script)"
          pwsh ./scripts/Wait-For-AadPrincipal.ps1 -PrincipalId $identityPrincipal -TimeoutSeconds 180

          roleGuid='b24988ac-6180-42a0-ab88-20f7382dd24c'
          roleId="/subscriptions/${{ parameters.subscriptionId }}/providers/Microsoft.Authorization/roleDefinitions/$roleGuid"
          az deployment group create --name assign-role --resource-group "$rgName" --template-file deploy-role-assignment.bicep --parameters principalId="$identityPrincipal" roleDefinitionId="$roleId"
    - task: AzureCLI@2
      displayName: 'Validate deployment (pre-check)'
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az account set --subscription "${{ parameters.subscriptionId }}"
          az deployment group validate --resource-group "${{ parameters.resourceGroupName }}" --template-file main.bicep --parameters "@main.parameters.json"

  - job: CreateResourceGroup
    displayName: 'Create Resource Group'
    dependsOn: PrepareParameters
    steps:
    - task: AzurePowerShell@5
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        ScriptType: 'FilePath'
        ScriptPath: '$(System.DefaultWorkingDirectory)/scripts/Create-ResourceGroup.ps1'
        ScriptArguments: >
          -ResourceGroupName "${{ parameters.resourceGroupName }}"
          -Location "${{ parameters.location }}"
        azurePowerShellVersion: 'LatestVersion'

  - job: DeployBackupInfrastructure
    displayName: 'Deploy Backup Infrastructure'
    dependsOn: CreateResourceGroup
    condition: eq(${{ parameters.enableBackup }}, 'true')
    steps:
    # parameters file is generated and validated in the PrepareParameters job
    - task: AzurePowerShell@5
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        ScriptType: 'FilePath'
        ScriptPath: '$(System.DefaultWorkingDirectory)/scripts/Deploy-Backup.ps1'
        ScriptArguments: >
          -ResourceGroupName "${{ parameters.resourceGroupName }}"
          -Location "${{ parameters.location }}"
          -VaultName "${{ parameters.vaultName }}"
          -BackupPolicyName "${{ parameters.backupPolicyName }}"
          -BackupFrequency "${{ parameters.backupFrequency }}"
          -VaultSkuName "${{ parameters.vaultSkuName }}" \
          -VaultSkuTier "${{ parameters.vaultSkuTier }}"
        azurePowerShellVersion: 'LatestVersion'

    

  

  - job: DeployAutoEnablePolicy
    displayName: 'Deploy Auto-Enable Policy (DeployIfNotExists)'
    dependsOn: DeployBackupInfrastructure
    condition: eq(${{ parameters.enableAutoRemediation }}, 'true')
    steps:
    - task: AzurePowerShell@5
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        ScriptType: 'FilePath'
        ScriptPath: '$(System.DefaultWorkingDirectory)/scripts/Deploy-AutoEnablePolicySubscription.ps1'
        ScriptArguments: >
          -SubscriptionId "${{ parameters.subscriptionId }}" \
          -Location "${{ parameters.location }}" \
          -VmTagName "${{ parameters.vmTagName }}" \
          -VmTagValue "${{ parameters.vmTagValue }}" \
          -BackupPolicyName "${{ parameters.backupPolicyName }}" \
          -VaultName "${{ parameters.vaultName }}" \
          -VaultResourceGroup "${{ parameters.vaultResourceGroup }}" \
          -CreateVault "${{ parameters.createVault }}"
        azurePowerShellVersion: 'LatestVersion'

    - task: AzureCLI@2
      displayName: 'Ensure policy assignment has system-assigned identity and grant Contributor on vault RG'
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        scriptType: 'ps'
        scriptLocation: 'inlineScript'
        inlineScript: |
          $subscriptionId = "${{ parameters.subscriptionId }}"
          $assignmentName = 'enable-vm-backup-assignment'
          $policyName = 'deployifnotexists-enable-vm-backup'
          $vaultRg = "${{ parameters.vaultResourceGroup }}"

          $scope = "/subscriptions/$subscriptionId"

          Write-Host "Resolving policy id for $policyName"
          $policyId = az policy definition show --name $policyName --query id -o tsv
          if (-not $policyId) { Write-Error "Policy definition $policyName not found"; exit 1 }

          # create or update assignment with system assigned identity
          $exists = az policy assignment show --name $assignmentName --scope $scope --query name -o tsv 2>$null
          if ($exists) {
            Write-Host "Updating assignment $assignmentName to ensure system-assigned identity"
            az policy assignment update --name $assignmentName --scope $scope --policy $policyId --display-name 'Enable VM backup for tagged VMs' --identity '{"type":"SystemAssigned"}' --location "${{ parameters.location }}"
          } else {
            Write-Host "Creating assignment $assignmentName with system-assigned identity"
            az policy assignment create --name $assignmentName --scope $scope --policy $policyId --display-name 'Enable VM backup for tagged VMs' --description 'Assign DeployIfNotExists policy to enable VM backup for VMs with the tag.' --identity '{"type":"SystemAssigned"}' --location "${{ parameters.location }}"
          }

          # wait for identity to be provisioned and get principalId
          $principalId = $null
          $retries = 0
          while (-not $principalId -and $retries -lt 12) {
            Start-Sleep -Seconds 5
            $principalId = az policy assignment show --name $assignmentName --scope $scope --query identity.principalId -o tsv 2>$null
            $retries++
          }
          if (-not $principalId) { Write-Error "Managed identity not available for policy assignment $assignmentName"; exit 1 }
          Write-Host "Managed identity principalId: $principalId"

          # grant Contributor on the vault resource group
          $rgScope = "/subscriptions/$subscriptionId/resourceGroups/$vaultRg"
          Write-Host "Assigning Contributor role to principal $principalId on $rgScope"
          try {
            az role assignment create --assignee-object-id $principalId --role "Contributor" --scope $rgScope | Out-Null
            Write-Host "Role assignment created"
          } catch {
            Write-Host "Role assignment may already exist or failed: $($_.Exception.Message)"
          }

    - task: AzureCLI@2
      displayName: 'Create subscription-scoped policy assignment via bicep using UAI'
      inputs:
        azureSubscription: 'bicep_deploy_SC'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          set -euo pipefail
          subscriptionId="${{ parameters.subscriptionId }}"
          rgName="${{ parameters.resourceGroupName }}"
          policyName='deployifnotexists-enable-vm-backup'
          echo "Retrieving user-assigned identity id from resource group deployment outputs..."
          identityId=$(az deployment group show --name main --resource-group "$rgName" --query properties.outputs.userAssignedIdentityId.value -o tsv)
          if [ -z "$identityId" ]; then
            echo "Failed to get userAssignedIdentityId from group deployment outputs"
            exit 1
          fi
          echo "Found identity id: $identityId"

          echo "Creating subscription deployment to create policy assignment using the UAI"
          az deployment sub create --name assign-policy --template-file deploy-policy-subscription.bicep --parameters assignmentName='enable-vm-backup-assignment' policyDefinitionName=$policyName userAssignedIdentityId=$identityId
          # subscription scope deployments require a location
          az deployment sub create --location "${{ parameters.location }}" --name assign-policy --template-file deploy-policy-subscription.bicep --parameters assignmentName='enable-vm-backup-assignment' policyDefinitionName=$policyName userAssignedIdentityId=$identityId