name: Deploy Backup Infrastructure

on:
  workflow_dispatch:
    inputs:
      subscriptionId:
        description: 'Azure Subscription ID'
        required: true
      # location removed from workflow_dispatch inputs
      enableBackup:
        description: 'Enable VM Backup'
        required: false
        default: 'true'
        type: choice
        options: ['true', 'false']
      backupFrequency:
        description: 'Backup Frequency'
        required: false
        default: 'Daily'
        type: choice
        options: ['Daily', 'Weekly', 'Both']
      enableAutoRemediation:
        description: 'Enable Auto-Remediation'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']
      createVault:
        description: 'Create Vault if not exists'
        required: false
        default: 'false'
        type: choice
        options: ['true', 'false']
      vaultResourceGroup:
        description: 'Vault Resource Group'
        required: false
        default: 'rg-vault-default'
      backupPolicyName:
        description: 'Backup Policy Name'
        required: false
        default: 'DefaultPolicy'
      resourceGroupName:
        description: 'Resource Group Name'
        required: false
        default: 'rg-vmbackup-default'
      dailyRetentionDays:
        description: 'Daily Backup Retention Days'
        required: false
        default: '14'
      weeklyRetentionDays:
        description: 'Weekly Backup Retention Days'
        required: false
        default: '30'

jobs:
  deploy:
    runs-on: windows-latest

    env:
      # Static defaults
      MANAGEMENT_GROUP_ID: ''
      VM_TAG_NAME: 'backup'
      VM_TAG_VALUE: 'true'
      VAULT_NAME: 'rsv-backup-default'
      VAULT_SKU_NAME: 'RS0'
      VAULT_SKU_TIER: 'Standard'
      LOCATION: 'westeurope'

      # Map workflow inputs
      SUBSCRIPTION_ID: ${{ github.event.inputs.subscriptionId }}
      ENABLE_BACKUP: ${{ github.event.inputs.enableBackup }}
      BACKUP_FREQUENCY: ${{ github.event.inputs.backupFrequency }}
      ENABLE_AUTO_REMEDIATION: ${{ github.event.inputs.enableAutoRemediation }}
      CREATE_VAULT: ${{ github.event.inputs.createVault }}
      VAULT_RESOURCE_GROUP: ${{ github.event.inputs.vaultResourceGroup }}
      BACKUP_POLICY_NAME: ${{ github.event.inputs.backupPolicyName }}
      RESOURCE_GROUP_NAME: ${{ github.event.inputs.resourceGroupName }}
      DAILY_RETENTION_DAYS: ${{ github.event.inputs.dailyRetentionDays }}
      WEEKLY_RETENTION_DAYS: ${{ github.event.inputs.weeklyRetentionDays }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ðŸ” Azure login using your stored service principal secret
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.serivcon }}
          enableAzPSSession: true

      # ðŸ§© Initialize Azure PowerShell session (context already set by azure/login)
      - name: Initialize Azure PowerShell Session
        shell: pwsh
        env:
          AZUREPS_HOST_ENVIRONMENT: AzurePipelines
        run: |
          Install-Module Az.Accounts -Force -AllowClobber -Scope CurrentUser
          Install-Module Az.Resources -Force -AllowClobber -Scope CurrentUser
          # Context is already set by azure/login with enableAzPSSession: true
          Save-AzContext -Path "$env:USERPROFILE\azurecontext.json" -Force

      # ðŸ§± Prepare parameters
      - name: Prepare Deployment Parameters
        shell: pwsh
        env:
          AZUREPS_HOST_ENVIRONMENT: AzurePipelines
          AZURE_CREDENTIALS: ${{ secrets.serivcon }}
        run: |
          # Azure CLI login is already handled by azure/login action
          pwsh ./scripts/Set-DeploymentParameters.ps1 `
            -Location "$env:LOCATION" `
            -SubscriptionId "$env:SUBSCRIPTION_ID" `
            -VaultName "$env:VAULT_NAME" `
            -BackupPolicyName "$env:BACKUP_POLICY_NAME" `
            -DailyRetentionDays $env:DAILY_RETENTION_DAYS `
            -WeeklyRetentionDays $env:WEEKLY_RETENTION_DAYS `
            -VaultSkuName "$env:VAULT_SKU_NAME" `
            -VaultSkuTier "$env:VAULT_SKU_TIER"

      # ðŸ—ï¸ Create resource group
      - name: Create Resource Group
        shell: pwsh
        run: |
          # Azure CLI login is already handled by azure/login action
          az group create --name "$env:RESOURCE_GROUP_NAME" --location "$env:LOCATION"

      # ðŸ’¾ Deploy backup infrastructure
      - name: Deploy Backup Infrastructure
        if: ${{ env.ENABLE_BACKUP == 'true' }}
        shell: pwsh
        run: |
          # Azure CLI login is already handled by azure/login action
          az deployment group create `
            --resource-group "$env:RESOURCE_GROUP_NAME" `
            --template-file "main.bicep" `
            --parameters `
              location="$env:LOCATION" `
              vaultName="$env:VAULT_NAME" `
              backupPolicyName="$env:BACKUP_POLICY_NAME" `
              backupFrequency="$env:BACKUP_FREQUENCY" `
              vaultSkuName="$env:VAULT_SKU_NAME" `
              vaultSkuTier="$env:VAULT_SKU_TIER"

      # ðŸ›¡ï¸ Deploy auto-enable policy (Option B: preprocess JSON and create policy directly)
      - name: Deploy Auto-Enable Policy (preprocess JSON)
        if: ${{ env.ENABLE_AUTO_REMEDIATION == 'true' }}
        shell: pwsh
        run: |
          # Azure CLI login is already handled by azure/login action
          az account set --subscription "$env:SUBSCRIPTION_ID"

          # Build the full roleDefinitionId for Contributor-like role used by remediation
          $roleGuid = 'b24988ac-6180-42a0-ab88-20f7382dd24c'
          $roleId = "/subscriptions/$env:SUBSCRIPTION_ID/providers/Microsoft.Authorization/roleDefinitions/$roleGuid"

          # Read and replace placeholders in the policy JSON
          $raw = Get-Content -Path 'modules/autoEnablePolicy.rule.json' -Raw
          $resolved = $raw `
            -replace '__ROLEDEFID__', [Regex]::Escape($roleId) `
            -replace '__VAULT_NAME__', $env:VAULT_NAME `
            -replace '__VAULT_RG__', $env:VAULT_RESOURCE_GROUP `
            -replace '__BACKUP_POLICY__', $env:BACKUP_POLICY_NAME `
            -replace '__TAGNAME__', $env:VM_TAG_NAME `
            -replace '__TAGVALUE__', $env:VM_TAG_VALUE

          $outPath = 'modules/autoEnablePolicy.resolved.json'
          $resolved | Out-File -FilePath $outPath -Encoding utf8

          # Policy and assignment names
          $policyName = 'deployifnotexists-enable-vm-backup'
          $assignmentName = 'enable-vm-backup-assignment'

          # Create or update the policy definition
          $exists = az policy definition show --name $policyName --query name -o tsv 2>$null
          if ($exists) {
            az policy definition update --name $policyName --rules $outPath --display-name 'DeployIfNotExists: enable VM backup for tagged VMs'
          } else {
            az policy definition create --name $policyName --display-name 'DeployIfNotExists: enable VM backup for tagged VMs' --rules $outPath --mode Indexed
          }

          # Get the policy id
          $policyId = az policy definition show --name $policyName --query id -o tsv

          # Create or update the assignment at subscription scope
          $assignExists = az policy assignment show --name $assignmentName --scope "/subscriptions/$env:SUBSCRIPTION_ID" --query name -o tsv 2>$null
          if ($assignExists) {
            az policy assignment update --name $assignmentName --scope "/subscriptions/$env:SUBSCRIPTION_ID" --policy $policyId --display-name 'Enable VM backup for tagged VMs'
          } else {
            az policy assignment create --name $assignmentName --scope "/subscriptions/$env:SUBSCRIPTION_ID" --policy $policyId --display-name 'Enable VM backup for tagged VMs' --description 'Assign DeployIfNotExists policy to enable VM backup for VMs with the tag.'
          }
